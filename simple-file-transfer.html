<!DOCTYPE html>
<html>
<head>
    <title>Simple P2P File Transfer</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        input[type="file"] { margin: 10px 0; }
        .logs { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .progress { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: #007bff; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Simple P2P File Transfer</h1>
        
        <div id="status" class="status info">Connecting to server...</div>
        
        <div style="display: flex; gap: 20px; margin: 20px 0;">
            <div style="flex: 1;">
                <h3>ðŸ“¤ Send Files</h3>
                <button id="createRoomBtn" class="btn-primary" onclick="createRoom()">Create Room</button>
                <div id="roomInfo" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                    <strong>Room Code:</strong> <span id="roomCode"></span><br>
                    <strong>Status:</strong> <span id="connectionStatus">Waiting for receiver...</span>
                </div>
                <input type="file" id="fileInput" onchange="handleFileSelect()" style="width: 100%;">
                <button id="sendBtn" class="btn-success" onclick="sendFile()" disabled>Send File</button>
            </div>
            
            <div style="flex: 1;">
                <h3>ðŸ“¥ Receive Files</h3>
                <input type="text" id="roomCodeInput" placeholder="Enter room code" style="width: 100%; padding: 8px; margin: 5px 0;">
                <button id="joinRoomBtn" class="btn-primary" onclick="joinRoom()">Join Room</button>
                <div id="receiveInfo" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                    <strong>Status:</strong> <span id="receiveStatus">Waiting for file...</span>
                </div>
                <button id="downloadBtn" class="btn-success" onclick="downloadFile()" disabled>Download File</button>
            </div>
        </div>
        
        <div id="progressContainer" style="display: none;">
            <h4>Transfer Progress</h4>
            <div class="progress">
                <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
            </div>
            <div id="progressText">0%</div>
        </div>
        
        <div>
            <h4>Debug Logs</h4>
            <div id="logs" class="logs"></div>
            <button onclick="clearLogs()" class="btn-danger">Clear Logs</button>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let peerConnection = null;
        let dataChannel = null;
        let selectedFile = null;
        let receivedFile = null;
        let isSender = false;
        let roomCode = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            const color = type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function initSocket() {
            socket = io('http://localhost:3001');
            
            socket.on('connect', () => {
                log('Connected to server', 'success');
                updateStatus('Connected to server', 'success');
            });
            
            socket.on('disconnect', () => {
                log('Disconnected from server', 'error');
                updateStatus('Disconnected from server', 'error');
            });
            
            socket.on('room-created', (data) => {
                log(`Room created: ${data.roomCode}`, 'success');
                roomCode = data.roomCode;
                document.getElementById('roomCode').textContent = data.roomCode;
                document.getElementById('roomInfo').style.display = 'block';
                isSender = true;
                initWebRTC();
            });
            
            socket.on('room-joined', (data) => {
                log(`Joined room: ${data.roomCode}`, 'success');
                roomCode = data.roomCode;
                document.getElementById('receiveInfo').style.display = 'block';
                isSender = false;
                initWebRTC();
            });
            
            socket.on('webrtc-signal', async (data) => {
                log(`WebRTC signal: ${data.type}`);
                await handleWebRTCSignal(data);
            });
            
            socket.on('file-transfer-request', (data) => {
                log(`File transfer request: ${data.fileName}`);
                if (confirm(`Accept file transfer: ${data.fileName}?`)) {
                    socket.emit('file-transfer-response', { accepted: true });
                } else {
                    socket.emit('file-transfer-response', { accepted: false });
                }
            });
        }
        
        function initWebRTC() {
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(config);
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-signal', {
                        type: 'ice-candidate',
                        candidate: event.candidate
                    });
                }
            };
            
            peerConnection.ondatachannel = (event) => {
                log('Data channel received');
                dataChannel = event.channel;
                setupDataChannel(dataChannel);
            };
            
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`WebRTC state: ${state}`);
                if (isSender) {
                    document.getElementById('connectionStatus').textContent = state;
                } else {
                    document.getElementById('receiveStatus').textContent = state;
                }
            };
            
            if (isSender) {
                log('Creating data channel as sender...');
                dataChannel = peerConnection.createDataChannel('fileTransfer');
                setupDataChannel(dataChannel);
                
                peerConnection.createOffer().then(offer => {
                    return peerConnection.setLocalDescription(offer);
                }).then(() => {
                    socket.emit('webrtc-signal', {
                        type: 'offer',
                        signal: peerConnection.localDescription
                    });
                    log('Offer sent');
                }).catch(error => {
                    log(`Error creating offer: ${error}`, 'error');
                });
            }
        }
        
        function setupDataChannel(channel) {
            channel.onopen = () => {
                log('Data channel opened!', 'success');
                if (isSender) {
                    document.getElementById('connectionStatus').textContent = 'Connected - Ready to send';
                } else {
                    document.getElementById('receiveStatus').textContent = 'Connected - Ready to receive';
                }
            };
            
            channel.onmessage = (event) => {
                if (event.data instanceof ArrayBuffer) {
                    log(`Received chunk: ${event.data.byteLength} bytes`);
                    if (!receivedFile) {
                        receivedFile = new Uint8Array(0);
                    }
                    const newData = new Uint8Array(event.data);
                    const combined = new Uint8Array(receivedFile.length + newData.length);
                    combined.set(receivedFile);
                    combined.set(newData, receivedFile.length);
                    receivedFile = combined;
                } else {
                    const data = JSON.parse(event.data);
                    if (data.type === 'file-info') {
                        log(`File info: ${data.fileName} (${data.fileSize} bytes)`);
                        receivedFile = new Uint8Array(0);
                        document.getElementById('downloadBtn').disabled = false;
                    }
                }
            };
        }
        
        async function handleWebRTCSignal(data) {
            if (data.type === 'offer') {
                await peerConnection.setRemoteDescription(data.signal);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                socket.emit('webrtc-signal', {
                    type: 'answer',
                    signal: answer
                });
                log('Answer sent');
            } else if (data.type === 'answer') {
                await peerConnection.setRemoteDescription(data.signal);
            } else if (data.type === 'ice-candidate') {
                await peerConnection.addIceCandidate(data.candidate);
            }
        }
        
        function createRoom() {
            socket.emit('create-room', { role: 'sender' });
        }
        
        function joinRoom() {
            const roomCode = document.getElementById('roomCodeInput').value;
            if (roomCode) {
                socket.emit('join-room', { roomCode, role: 'receiver' });
            }
        }
        
        function handleFileSelect() {
            selectedFile = document.getElementById('fileInput').files[0];
            if (selectedFile) {
                log(`File selected: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`);
                document.getElementById('sendBtn').disabled = false;
            }
        }
        
        async function sendFile() {
            if (!selectedFile || !dataChannel || dataChannel.readyState !== 'open') {
                log('Cannot send file: connection not ready', 'error');
                return;
            }
            
            log(`Sending file: ${selectedFile.name}`);
            document.getElementById('progressContainer').style.display = 'block';
            
            // Send file info
            dataChannel.send(JSON.stringify({
                type: 'file-info',
                fileName: selectedFile.name,
                fileSize: selectedFile.size
            }));
            
            // Send file data
            const reader = new FileReader();
            reader.onload = (e) => {
                dataChannel.send(e.target.result);
                log('File sent successfully!', 'success');
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressText').textContent = '100%';
            };
            reader.readAsArrayBuffer(selectedFile);
        }
        
        function downloadFile() {
            if (receivedFile && receivedFile.length > 0) {
                const blob = new Blob([receivedFile]);
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'received-file';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log('File downloaded!', 'success');
            }
        }
        
        // Initialize
        initSocket();
    </script>
</body>
</html>
